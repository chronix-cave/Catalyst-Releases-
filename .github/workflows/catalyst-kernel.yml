name: Catalyst Kernel Release

on:
  push:
    tags:
      - "v*"
      - "R*"
      - "*-release"
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "Kernel branch to build"
        required: true
        default: "16"
      create_release:
        description: "Create GitHub Release"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150

    env:
      ARCH: arm64
      SUBARCH: arm64
      DEFCONFIG: vendor/violet-perf_defconfig
      KBUILD_BUILD_USER: Chronix
      KBUILD_BUILD_HOST: github-actions
      KERNEL_REPO: https://github.com/chronix-cave/kernel_xiaomi_violet.git
      DEFAULT_BRANCH: 16
      ANYKERNEL_REPO: https://github.com/ChroniX-AOSP/AnyKernel33.git
      CLANG_REPO: https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r547379.git
      KERNEL_NAME: Catalyst-r1-violet

    steps:
      - name: Determine build mode
        id: mode
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          else
            VERSION="manual-$(date +%Y%m%d-%H%M)"
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.inputs.kernel_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git zip bc bison flex libssl-dev libelf-dev ccache build-essential gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Clone Toolchain & Source
        run: |
          git clone --depth=1 -b "${{ steps.mode.outputs.branch }}" "$KERNEL_REPO" kernel
          git clone --depth=1 "$ANYKERNEL_REPO" AnyKernel3
          git clone --depth=1 "$CLANG_REPO" clang
          
      - name: Get Toolchain Info
        id: clang_info
        run: |
          echo "version=$(clang/bin/clang --version | head -n 1)" >> $GITHUB_OUTPUT

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ steps.mode.outputs.branch }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ steps.mode.outputs.branch }}
            ${{ runner.os }}-ccache-

      - name: Setup environment
        run: |
          echo "$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_PATH
          echo "CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV

      - name: Build Kernel
        id: build_kernel
        run: |
          START=$(date +%s)
          cd kernel
          ccache -z
          make O=out ARCH=arm64 $DEFCONFIG
          
          THREADS=$(nproc --all)
          make -j"$THREADS" O=out \
            ARCH=arm64 \
            CC="ccache clang" \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            LLVM=1 LLVM_IAS=1 \
            HOSTCC=clang \
            HOSTLD=ld.lld

          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=$((DURATION / 60))m $((DURATION % 60))s" >> $GITHUB_OUTPUT
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Package Zip
        id: package
        run: |
          VERSION="${{ steps.mode.outputs.version }}"
          ZIP_NAME="${{ env.KERNEL_NAME }}-${VERSION}.zip"
          cp kernel/out/arch/arm64/boot/Image.gz AnyKernel3/
          cd AnyKernel3
          zip -r9 "$ZIP_NAME" ./* -x ".git/*"
          SHA256=$(sha256sum "$ZIP_NAME" | awk '{print $1}')
          echo "$SHA256" > "$ZIP_NAME.sha256"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Create Release
        if: success() && (steps.mode.outputs.is_tag == 'true' || github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.mode.outputs.version }}
          name: "ğŸš€ Catalyst Kernel ${{ steps.mode.outputs.version }}"
          body: |
            ## ğŸ“¦ Build Information
            | Property | Value |
            |-----------|--------|
            | **Version** | `${{ steps.mode.outputs.version }}` |
            | **Branch** | `${{ steps.mode.outputs.branch }}` |
            | **Commit** | `${{ steps.build_kernel.outputs.commit_hash }}` |
            | **Build Time** | `${{ steps.build_kernel.outputs.duration }}` |

            ## ğŸ›  Toolchain
            ```
            ${{ steps.clang_info.outputs.version }}
            ```

            ## ğŸ” Integrity
            `SHA256: ${{ steps.package.outputs.sha256 }}`
          files: |
            AnyKernel3/${{ steps.package.outputs.zip_name }}
            AnyKernel3/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}