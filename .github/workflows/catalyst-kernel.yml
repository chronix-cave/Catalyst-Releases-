name: Catalyst Kernel Release

on:
  push:
    tags:
      - "v*"
      - "R*"
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "Kernel branch to build"
        required: true
        default: "16"
      build_variant:
        description: "Select Build Variant"
        required: true
        default: "Standard"
        type: choice
        options:
          - "Standard"
          - "KSU"
          - "KSU-nxt"
      create_release:
        description: "Create GitHub Release"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150

    env:
      ARCH: arm64
      SUBARCH: arm64
      DEFCONFIG: vendor/violet-perf_defconfig
      KBUILD_BUILD_USER: Chronix
      KBUILD_BUILD_HOST: github-actions
      KERNEL_REPO: https://github.com/chronix-cave/kernel_xiaomi_violet.git
      ANYKERNEL_REPO: https://github.com/ChroniX-AOSP/AnyKernel33.git
      CLANG_REPO: https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r547379.git
      KERNEL_NAME: Catalyst-r1-violet

    steps:
      - name: Determine Versioning
        id: mode
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "branch=16" >> $GITHUB_OUTPUT
          else
            VARIANT="${{ github.event.inputs.build_variant }}"
            VERSION="${{ github.event.inputs.kernel_branch }}-${VARIANT}-$(date +%Y%m%d-%H%M)"
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.inputs.kernel_branch }}" >> $GITHUB_OUTPUT
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git zip bc bison flex libssl-dev libelf-dev ccache build-essential gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Clone Components
        run: |
          git clone --depth=1 -b "${{ steps.mode.outputs.branch }}" "$KERNEL_REPO" kernel
          git clone --depth=1 "$ANYKERNEL_REPO" AnyKernel3
          git clone --depth=1 "$CLANG_REPO" clang

      - name: Setup Toolchain & Cache
        id: setup
        run: |
          echo "$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_PATH
          echo "CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          echo "clang_ver=$(clang/bin/clang --version | head -n 1)" >> $GITHUB_OUTPUT

      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ steps.mode.outputs.branch }}-${{ github.sha }}
          restore-keys: ${{ runner.os }}-ccache-${{ steps.mode.outputs.branch }}

      - name: Generate Metadata
        id: meta
        run: |
          cd kernel
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          if [ -z "$PREV_TAG" ]; then
            git log --oneline -n 10 --no-merges --pretty=format:"â€¢ %s" >> $GITHUB_OUTPUT
          else
            git log ${PREV_TAG}..HEAD --oneline --no-merges --pretty=format:"â€¢ %s" >> $GITHUB_OUTPUT
          fi
          echo -e "\nEOF" >> $GITHUB_OUTPUT

      - name: Build Kernel
        id: build
        run: |
          cd kernel
          START=$(date +%s)
          ccache -z
          make O=out ARCH=arm64 $DEFCONFIG
          make -j$(nproc --all) O=out ARCH=arm64 CC="ccache clang" \
               CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
               LLVM=1 LLVM_IAS=1 HOSTCC=clang HOSTLD=ld.lld
          
          END=$(date +%s)
          DIFF=$((END - START))
          echo "duration=$((DIFF / 60))m $((DIFF % 60))s" >> $GITHUB_OUTPUT

      - name: Package & Sign
        id: package
        run: |
          ZIP_NAME="${{ env.KERNEL_NAME }}-${{ steps.mode.outputs.version }}.zip"
          cp kernel/out/arch/arm64/boot/Image.gz AnyKernel3/
          cd AnyKernel3
          zip -r9 "$ZIP_NAME" ./* -x ".git/*"
          SHA=$(sha256sum "$ZIP_NAME" | awk '{print $1}')
          echo "$SHA" > "$ZIP_NAME.sha256"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "size=$(du -sh $ZIP_NAME | cut -f1)" >> $GITHUB_OUTPUT

      - name: Push Release
        if: success() && (steps.mode.outputs.is_tag == 'true' || github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.mode.outputs.version }}
          name: "ğŸš€ Catalyst ${{ steps.mode.outputs.version }}"
          body: |
            ### ğŸ“¦ Build Info
            - **Commit:** `${{ steps.meta.outputs.commit }}`
            - **Toolchain:** `${{ steps.setup.outputs.clang_ver }}`
            - **SHA256:** `${{ steps.package.outputs.sha }}`
          files: |
            AnyKernel3/${{ steps.package.outputs.zip_name }}
            AnyKernel3/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Telegram
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          document: |
            AnyKernel3/${{ steps.package.outputs.zip_name }}
            AnyKernel3/${{ steps.package.outputs.zip_name }}.sha256
          message: |
            <b>ğŸš€ Catalyst Kernel Release</b>
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            <b>ğŸ“± Device:</b> <code>Xiaomi Violet</code>
            <b>ğŸ§¬ Variant:</b> <code>${{ github.event.inputs.build_variant || 'Push' }}</code>
            <b>ğŸ· Version:</b> <code>${{ steps.mode.outputs.version }}</code>
            <b>ğŸ“¦ Size:</b> <code>${{ steps.package.outputs.size }}</code>
            <b>ğŸ•’ Duration:</b> <code>${{ steps.build.outputs.duration }}</code>
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            <b>ğŸ“ Changelog:</b>
            ${{ steps.meta.outputs.changelog }}
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            <b>ğŸ”— Links:</b>
            â€¢ <a href="https://github.com/${{ github.repository }}/releases/tag/${{ steps.mode.outputs.version }}">GitHub Release</a>
            
            <b>ğŸ›¡ SHA256:</b>
            <code>${{ steps.package.outputs.sha }}</code>